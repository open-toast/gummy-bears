# Gummy Bears

D8 sugar for all of your animal sniffing needs.

## Animal Sniffer - Background

[Animal Sniffer](https://www.mojohaus.org/animal-sniffer/) provides tools to assert your project is binary compatibile with a specific version of a library. We use Animal Sniffer to ensure that libraries consumed by toastmobile do not use any APIs not available on Android 4.4.

Animal Sniffer works by introspecting your project's bytecode and matching it against a set of signatures. Conveniently, standard sets of signatures for all JDKs and Android SDKs are available on Maven Central. Standard signatures are generated by introspecting library's bytecode (i.e. android.jar for Android SDK) and recording all public binary interfaces it exposes.

## Android

Let's look at [Integer.hashCode(int)](https://developer.android.com/reference/java/lang/Integer#hashCode(int)). The documentation says it was `Added in API level 24`, and yet it works perfectly fine on `API 19`. Moreover, the Kotlin compiler, when targeting `1.8` bytecode level, will generate calls to this method to compute the hash code of `Int` fields of a `data class`.

When the APK is assembled, D8 (the Android Dexer) transforms java bytecode into Android (Dalvik/Art) bytecode. As part of that transformation, it rewrites (or _desugars_) some instructions and API calls. For example, lambdas are desuraged into anonymous classes, `try-with-resources` is desugared into a Dalvik-compatible set of instructions that matches the semantics of _regular_ Java's `try-with-resources`, and `Integer.hashCode(int)` is rewritten into a call to a synthetic class which is then added to the APK by D8.

## Gummy Bears

The set of desugared methods is defined by the version of D8, which itself is defined by the android gradle plugin, and the minimum SDK level.

This project provides a safe and more accurate set of signatures for Android 4.4/Android Gradle 3.x. In the future, we will provide an expanded set of signatures for Android Gradle 4.x including `java.time`, `ConcurrentHashMap`, etc.
